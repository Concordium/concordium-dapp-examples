name: Fmt and Clippy

# This job runs rustfmt and clippy linting,

on:
  push:
    branches: main

  pull_request:
    branches: main
    paths:
      - 'gallery/verifier/**'
      - 'low-code-nft-marketplace/cis2-market/**'
      - 'sponsoredTransactions/**'
      - 'sponsoredTransactionsAuction/backend/**'
      - 'trackAndTrace/smart-contract/**'
      - 'trackAndTrace/test-scripts/**'
      - 'trackAndTrace/indexer/**'
      - 'trackAndTrace/sponsored-transaction-service/**'
      - 'compliant-reward-distribution/indexer-and-server/**'

  workflow_dispatch: # allows manual trigger

env:
  RUST_FMT: nightly-2023-04-01-x86_64-unknown-linux-gnu
  RUST_VERSION: 1.85
  CARGO_CONCORDIUM_VERSION: "4.2.0"

jobs:
  changes:
    name: Detect changed files in Rust projects
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    outputs:
      paths: ${{ steps.rust-directories.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Check for backend file changes for Docker builds
        uses: dorny/paths-filter@v3
        id: rust-changes
        with:
          list-files: json
          filters: |
            rust:
            - '**/*.rs'
  
      - name: Print the list of files
        id: rust-directories
        run: |
          echo "Print the output"
          echo ${{ steps.rust-changes.outputs.rust_files }}
          echo '${{ steps.rust-changes.outputs.rust_files }}' | jq '[.[] | split("/")[:2] | join("/")] | unique' 
          matrix=$(echo '${{ steps.rust-changes.outputs.rust_files }}' | jq -c '[.[] | split("/")[:2] | join("/")] | unique')
          echo "printing resulting variable"
          echo $linters
          echo "writing to github output"
          echo "matrix=${matrix}" >> $GITHUB_OUTPUT
     
  lint_fmt:
    name: Running formatting
    needs: changes
    # Don't run on draft pull requests, or if there are no changes in Rust files. 
    if: ${{ !github.event.pull_request.draft && needs.changes.outputs.paths != '[]' && needs.changes.outputs.paths != '' }}
    runs-on: ubuntu-latest  
    strategy:
      matrix:
        paths: ${{ fromJSON(needs.changes.outputs.paths) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Get toolchain
        # Ensure rustfmt is installed and setup problem matcher
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_FMT }}
          components: rustfmt
      - name: Rustfmt Check
        run: cargo fmt --manifest-path=${{ matrix.paths }}/Cargo.toml -- --check

  lint_clippy:
    name: Running clippy
    needs: changes
    # Don't run on draft pull requests, or if there are no changes in Rust files. 
    if: ${{ !github.event.pull_request.draft && needs.changes.outputs.paths != '[]' && needs.changes.outputs.paths != '' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        paths: ${{ fromJSON(needs.changes.outputs.paths) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Get toolchain
        # Ensure rustfmt is installed and setup problem matcher
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: clippy
      - name: Run cargo clippy
        run: cargo clippy --manifest-path=${{ matrix.paths }}/Cargo.toml --locked -- -D warnings

  build:
    name: Build Rust project
    needs: changes
    # Don't run on draft pull requests, only run on trackAndTrace and compliant-reward-distribution
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        paths: ${{ fromJSON(needs.changes.outputs.paths) }}

    steps:
      - name: Checkout
        if: ${{ contains(fromJson('["trackAndTrace"]'), matrix.paths) || contains(fromJson('["compliant-reward-distribution"]'), matrix.paths) }}
        id: checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Get toolchain
        if: ${{ contains(fromJson('["trackAndTrace"]'), matrix.paths) || contains(fromJson('["compliant-reward-distribution"]'), matrix.paths) }}
        # Ensure rustfmt is installed and setup problem matcher
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Run cargo build
        if: ${{ contains(fromJson('["trackAndTrace"]'), matrix.paths) || contains(fromJson('["compliant-reward-distribution"]'), matrix.paths) }}
        run: cargo build --manifest-path=${{ matrix.paths }}/Cargo.toml --locked

  test:
    name: Running cargo-concordium tests
    needs: changes
    # Don't run on draft pull requests,  only run on trackAndTrace and compliant-reward-distribution
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu

        paths: ${{ fromJSON(needs.changes.outputs.paths) }}

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install toolchain
        if: ${{ contains(fromJson('["trackAndTrace/smart-contract"]'), matrix.paths ) || contains(fromJson('["low-code-nft-marketplace/cis2-market"]'), matrix.paths) }}
        uses: actions-rs/toolchain@v1.0.6
        with:
          profile: minimal
          toolchain: ${{ env.RUST_VERSION }}
          target: ${{ matrix.target }}
          override: true

      - name: Install Wasm target
        if: ${{ contains(fromJson('["trackAndTrace/smart-contract"]'), matrix.paths ) || contains(fromJson('["low-code-nft-marketplace/cis2-market"]'), matrix.paths) }}
        run: rustup target install wasm32-unknown-unknown

      - name: Download and install Cargo Concordium
        if: ${{ contains(fromJson('["trackAndTrace/smart-contract"]'), matrix.paths ) || contains(fromJson('["low-code-nft-marketplace/cis2-market"]'), matrix.paths) }}
        run: |
          curl -L https://github.com/Concordium/concordium-smart-contract-tools/releases/download/releases/cargo-concordium/${CARGO_CONCORDIUM_VERSION}/cargo-concordium-linux-amd64 -o /tmp/cargo-concordium
          chmod +x /tmp/cargo-concordium
          sudo mv /tmp/cargo-concordium /usr/bin/cargo-concordium

      - name: Run cargo concordium test
        if: ${{ contains(fromJson('["trackAndTrace/smart-contract"]'), matrix.paths ) || contains(fromJson('["low-code-nft-marketplace/cis2-market"]'), matrix.paths) }}
        run: cargo concordium test --out "${{ matrix.paths }}/concordium-out/module.wasm.v1" -- --manifest-path "${{ matrix.paths }}/Cargo.toml"
